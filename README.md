# Simple sequence repeats power *Staphylococcus aureus* adaptation

## Helper scripts documentation

This document provides detailed descriptions and usage for the scripts used in the study: “Simple sequence repeats power *Staphylococcus aureus* adaptation”. Each script’s purpose, usage, parameters, dependencies, and role in the workflow as described in the Methods section are explained.

---

## 1. `homoplastic_score.R`

### Purpose
Calculates homoplasy metrics (extra steps, consistency index, homoplasy slope, homoplasy slope ratio) for a given mutation across a phylogeny. Used to identify convergent (homoplastic) mutations in the context of the core SNP phylogeny of *S. aureus*.

### Dependencies
- **R (≥ 3.x)**
- R packages:
  - **phangorn** (phylogenetic analysis)
  - **ape** (phylogenetic tree reading)
  - **argparser** (argument parsing)
- **sgrep** (sorted grep for extracting mutation IDs)

### Usage
```bash
Rscript homoplastic_score.R <tree> <mutation_db> <mutation_id> [--nsims N] [--avg_hs VAL]
```

**Arguments:**
- `tree`: Path to the phylogenetic tree in Newick format (e.g., from RAxML).
- `mutation_db`: Sorted mutation database file (first column must be mutation ID).
- `mutation_id`: Mutation ID to analyze.
- `--nsims`: (Optional) Number of simulations for average homoplasy slope calculation (default: 100).
- `--avg_hs`: (Optional) Skip simulation and use this value as average homoplasy slope.

### Output
Tab-delimited metrics: mutation count, number of convergent acquisitions, consistency index, homoplasy slope, average homoplasy slope, homoplasy slope ratio.

### Methods Reference
Used to assign number of convergent acquisitions to variants across 7,099 *S. aureus* genomes, as described in the Convergence analysis and CMAS calculation section.

---

## 2. `sample_run_gubbins.sh`

### Purpose
Runs Gubbins recombination detection on multiple random subsamples of a whole-genome alignment. Facilitates robust estimation of recombination rates at each genome position by repeated sampling.

### Dependencies
- **bash** (Unix shell)
- **awk** (text processing)
- **shuf** (randomization)
- **head** (text processing)
- **cat** (text processing)
- **run_gubbins.py** (Gubbins, v2.4.1+)
- **seq** (sequence generation; coreutils)

### Usage
```bash
bash sample_run_gubbins.sh
```
**Variables (set at the top):**
- `FA_TO_SAMPLE`: Path to the full core alignment FASTA (default: `../../core.full.aln`).
- `N_SAMPLE`: Number of subsampled runs (default: 100).
- `SIZE_SAMPLE`: Number of genomes per subsample (default: 100).
- `MIN_SNPS`: Minimum SNPs for Gubbins run (default: 10).

### Output
Generates multiple Gubbins output files (`gubbins.samp...`), each corresponding to a different random subset.

### Methods Reference
Described under Convergence analysis and CMAS calculation. Recombination was estimated for every genome position by running gubbins 8 times on subsampled phylogenetic trees.

---

## 3. `get_gap_ambiguous_snp_score.sh`

### Purpose
Calculates the percentage of gaps, ambiguous bases, and SNPs at every position in a full genome alignment, generating userplot files for visualization. Used to filter out low-confidence positions prior to CMAS calculation.

### Dependencies
- **bash** (Unix shell)
- **trimal** (v1.4 or later; sequence alignment trimming and stats)
- **sed** (stream editor)
- **awk** (text processing)
- **grep** (text search)
- **cut** (text processing)
- **rm** (file removal)

### Usage
```bash
bash get_gap_ambiguous_snp_score.sh <alignment>
```
- `<alignment>`: Core genome alignment file (output from snippy).

### Output
Creates several files:
- `${aln}.pct_gap`, `${aln}.pct_gap_ambiguous`, `${aln}.pct_ambiguous`, `${aln}.pct_snp`: Tabular files with per-position stats.
- `.userplot` files: Int format, compatible with Artemis for plotting.
- Cleans up intermediate files.

### Methods Reference
Used as described in Convergence analysis and CMAS calculation to determine the percentage of ambiguous and gap calls at every position.

---

## 4. `rmseq_SSR_count.sh`

### Purpose
Counts the frequency of SSR (simple sequence repeat) lengths in amplicon sequencing data generated by RM-seq, focusing on specific SSR patterns. Outputs a table of counts for each SSR length and sample.

### Dependencies
- **bash** (Unix shell)
- **cut** (text processing)
- **grep** (text search)
- **wc** (word/line counting)
- **tail** (text processing)
- **echo** (text output)

### Usage
```bash
bash rmseq_SSR_count.sh <file1> [<file2> ...]
```
- `<file>`: RM-seq amplicon effect file(s) to process.

### Output
Tabulated summary:
- Columns: sample name, counts for each SSR length (10A, 9A, ..., 5A), total count.

### Methods Reference
Used in RM-seq amplicon deep-sequencing of SSR loci to count and compare SSR lengths across samples.

---

## 5. `hetero_SSR_call.sh`

### Purpose
Identifies SSR (simple sequence repeat) variant subpopulations in sequence data from human-derived samples. Maps reads, calculates coverage, prepares BAMs for low-frequency variant calling with LoFreq, and normalizes indel calls.

### Dependencies
- **bash** (Unix shell)
- **bwa** (read mapper)
- **samtools** (v1.10+; BAM handling, coverage stats)
- **lofreq** (v2.1.2+; low-frequency variant caller)
- **vcfallelicprimitives** (vcflib; VCF normalization)
- **awk** (text processing)
- **cut** (text processing)
- **basename** (coreutils)

### Usage
```bash
bash hetero_SSR_call.sh <reference_fasta> <sample_R1.fastq> <sample_R2.fastq>
```
- `<reference_fasta>`: Reference genome (e.g., *S. aureus* NRS384).
- `<sample_R1.fastq>`: Forward reads.
- `<sample_R2.fastq>`: Reverse reads.

### Output
- `${sample}.bam`: Sorted BAM.
- `${sample}_coverage_mean_std.tsv`, `${sample}_coverage.tsv`: Coverage stats.
- `${sample}_lofreq2_allelicprimitives.vcf`: Normalized VCF of low-frequency variants.

### Methods Reference
Described in Identification of SSR variants subpopulations in human derived samples. Automates mapping, LoFreq calling, and variant filtering pipeline.

---


These scripts are integrated at multiple points in the study’s pipeline:
- Homoplasy and convergence analysis (`homoplastic_score.R`) builds directly on variant calls and phylogenetic trees.
- Recombination filtering (`sample_run_gubbins.sh`) and alignment quality checks (`get_gap_ambiguous_snp_score.sh`) ensure high-confidence positions for CMAS analyses.
- SSR quantification (`rmseq_SSR_count.sh` and `hetero_SSR_call.sh`) enables exploration of SSR variation from amplicon (RM-seq) and shotgun metagenomic data.

Please see the Methods section of the manuscript for more context and rationale for each script’s use.

---

## Testing

A comprehensive test suite with simulated datasets is available in the `tests/` directory. Each script has:
- Minimal test input data
- Automated test scripts
- Documentation of expected outputs

To run tests:
```bash
cd tests
bash run_all_tests.sh  # Run all tests (requires dependencies)
bash test_rmseq_SSR_count.sh  # Run individual test
```

See [tests/README.md](tests/README.md) for detailed information about test data, dependencies, and expected outputs.

---
